---
output: github_document
title: "Net Electricity Consumption"
---

Visualization of electricity production by balcony power station and net electricity usage, measured by electricity meter.

<div>
by <a href="mailto:firstname.lastname@outlook.com">Konstantin</a> on `r Sys.time()`
</div>

```{r init, echo = FALSE}
# load packages
library(conflicted)
library(dplyr)
library(forcats)
library(ggplot2)
library(knitr)
library(readxl)
library(purrr)
library(tibble)
library(tidyr)

# solve package conflicts
# conflict_scout()
conflicts_prefer(dplyr::filter(), dplyr::lag(), .quiet = TRUE)

# set knitr options
opts_chunk$set(
  echo = FALSE,
  fig.path = file.path("img", .Platform$file.sep)
)
```

## Data prep

```{r file-names}
# electricity meter
fnam_em <- file.path("data", "electricity_meter.csv")

# power station
fnam_ps <- list.files("data", pattern = "power-station", full.names = TRUE)
```

Import electricity net consumption from file

`r fnam_em`.

Import electricity production from files

`r paste("* ", fnam_ps, collapse = "\n")`

```{r import}
# electricity measure
df_em <- read.csv(fnam_em) %>% 
  as_tibble() %>% 
  mutate(
    dt    = as.Date(dt, format = "%Y-%m-%d"),
    dttm  = as.POSIXct(paste(dt, tm), format = "%Y-%m-%d %H:%M"),
    aux   = as.double(dttm) / (3600 * 24),
    tdif  = aux - lag(aux),
    usage = kwh - lag(kwh),
    avgu  = usage / tdif
  ) %>% 
  select(dt, avgu)

# power station
df_ps <- 
  map_df(
    fnam_ps,
    .f = \(f) {
      #-- f <- fnam_ps[1]
      read_xlsx(f) %>% 
        select(dt = 2, prod = 4) %>% 
        mutate(
          dt   = as.Date(dt, format = "%Y/%m/%d"),
          prod = as.double(prod)
        ) %>% 
        select(dt, prod)
    }
  )
```

**Process** data

*  create data with average electricity usage by date
*  combine both data, electricity net usage and electricity production

```{r process}
# get date range
dt_range <- range(df_em$dt)

# em grid with average net electricity usage
df_em_grid <- 
  tibble(dt = seq(dt_range[1], dt_range[2], by = "d")) %>% 
  left_join(
    y = df_em %>% select(dt, avgu) %>% filter(!is.na(avgu)),
    by = join_by(dt)
  ) %>% 
  fill(avgu, .direction = "up")

df_all <- 
  full_join(x = df_ps, y = df_em_grid, by = join_by(dt)) %>% 
  pivot_longer(cols = c(prod, avgu), names_to = "cat", values_to = "kwh") %>% 
  mutate(
    cat = factor(
      cat,
      levels = c("prod", "avgu"),
      labels = c("produced", "average net usage")
    )
  ) %>% 
  filter(!is.na(kwh))
```

## Evaluation

```{r viz}
df_all %>% 
  ggplot(mapping = aes(x = dt, y = kwh, group = cat, fill = cat)) + 
  geom_col() + 
  geom_text(
    aes(label = sprintf(fmt = "%.1f", kwh)),
    position = position_stack(vjust = 0.5),
    size = 3, color = "white", angle = 90
  ) +
  geom_hline(yintercept = c(0, 2000/365)) + 
  scale_x_date(
    date_breaks = "1 week", date_labels = "%d %b", minor_breaks = NULL
  ) +
  scale_y_continuous(
    sec.axis = dup_axis(
      name = NULL, breaks = round(2000/365, 2), label = "daily\naverage\n2024"
    )
  ) + 
  scale_fill_manual(values = c("#00BFC4", "#F8766D")) +
  labs(x = NULL, y = "kWh", fill = NULL) + 
  theme_minimal() + 
  theme(legend.position = "bottom")
```


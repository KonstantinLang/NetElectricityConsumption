---
output: github_document
title: "Net Electricity Consumption"
---

Visualization of electricity production by balcony power station and net electricity usage, measured by electricity meter.

<div>
by <a href="mailto:firstname.lastname@outlook.com">Konstantin</a> on `r Sys.time()`
</div>

```{r init, echo = FALSE}
# load packages
library(conflicted)
library(dplyr)
library(forcats)
library(ggplot2)
library(knitr)
library(readxl)
library(purrr)
library(stringr)
library(tibble)
library(tidyr)

# solve package conflicts
# conflict_scout()
conflicts_prefer(dplyr::filter(), dplyr::lag(), .quiet = TRUE)

# set knitr options
opts_chunk$set(
  echo = FALSE,
  fig.path = file.path("img", .Platform$file.sep)
)
```

## Data prep

```{r file-names}
# electricity meter
fnam_em <- file.path("data", "electricity_meter.csv")

# power station
fnam_ps_daily <- list.files(file.path("data", "ps_daily"), full.names = TRUE)
fnam_ps_detail <- list.files(file.path("data", "ps_detail"), full.names = TRUE)
```

Import electricity net consumption from file

`r fnam_em`.

Import electricity production on a daily level from files

`r paste("* ", fnam_ps_daily, collapse = "\n")`

Import electricity production on a detailed level from files

`r paste("* ", fnam_ps_detail, collapse = "\n")`

```{r import}
# electricity measure
df_em <- read.csv(fnam_em) %>% 
  as_tibble() %>% 
  mutate(
    dt    = as.Date(dt, format = "%Y-%m-%d"),
    dttm  = as.POSIXct(paste(dt, tm), format = "%Y-%m-%d %H:%M"),
    aux   = as.double(dttm) / (3600 * 24),
    tdif  = aux - lag(aux),
    usage = kwh - lag(kwh),
    avgu  = usage / tdif
  )

# power station
df_ps_daily <- 
  map_df(
    fnam_ps_daily,
    .f = \(f) {
      #-- f <- fnam_ps_daily[1]
      read_xlsx(f) %>% 
        select(dt = 2, prod = 4) %>% 
        mutate(
          dt   = as.Date(dt, format = "%Y/%m/%d"),
          prod = as.double(prod)
        ) %>% 
        select(dt, prod)
    }
  ) %>% 
  mutate(month = factor(months(dt), levels = month.name))

df_ps_detail <- 
  map_df(
    fnam_ps_detail,
    .f = \(f) {
      #-- f <- fnam_ps_detail[1]
      read_xlsx(f) %>% 
        select(dttm = 2, prod = 4) %>% 
        mutate(
          dt   = word(dttm) %>% as.Date(format = "%Y/%m/%d"),
          tm   = word(dttm, start = 2) %>% 
            as.difftime(format = "%H:%M", unit = "hours"),
          dttm = as.POSIXct(dttm),
          prod = as.double(prod)
        ) %>% 
        select(dttm, dt, tm, prod)
    }
  )
```

```{r, eval = FALSE}
df_ps_detail %>% 
  summarize(
    nrec = n(),
    nvld = sum(!is.na(prod)),
    nmis = sum(is.na(prod)),
    qrt0 = quantile(prod, prob = 0, na.rm = TRUE),
    qrt1 = quantile(prod, prob = .25, na.rm = TRUE),
    qrt2 = quantile(prod, prob = .5, na.rm = TRUE),
    qrt3 = quantile(prod, prob = .75, na.rm = TRUE),
    qrt4 = quantile(prod, prob = 1, na.rm = TRUE),
    .by = tm
  ) %>% 
  arrange(tm) %>% 
  ggplot(mapping = aes(x = tm, y = qrt4)) + 
  geom_line() + 
  theme_minimal()
```


**Process** data

*  create data with average electricity usage by date
*  combine both data, electricity net usage and electricity production

```{r process}
# get date range
dt_range <- range(df_em$dt)

# em grid with average net electricity usage
df_em_grid <- 
  tibble(dt = seq(dt_range[1], dt_range[2], by = "d")) %>% 
  left_join(
    y = df_em %>% select(dt, avgu) %>% filter(!is.na(avgu)),
    by = join_by(dt)
  ) %>% 
  fill(avgu, .direction = "up")
```

## Evaluation

### Electricity meter

```{r}
df_em_grid %>% 
  ggplot(mapping = aes(x = dt, y = avgu)) +
  geom_hline(yintercept = 0) + 
  geom_step() + 
  labs(x = NULL, y = "kWh per day", fill = NULL) + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust = .5))
```


### Daily electricity production

```{r viz}
df_ps_daily %>% 
  ggplot(mapping = aes(x = dt, y = prod)) +
  facet_grid(cols = vars(month), scales = "free_x", space = "free_x") + 
  geom_hline(yintercept = 2000/365) + 
  geom_col() + 
  geom_text(
    aes(label = sprintf(fmt = "%.1f", prod)),
    position = position_stack(vjust = 0.5),
    size = 3, color = "white", angle = 90
  ) +
  scale_x_date(
    date_breaks = "1 week", date_labels = "%d %b", minor_breaks = NULL
  ) +
  labs(x = NULL, y = "kWh produced", fill = NULL) + 
  theme_minimal() + 
  theme(legend.position = "bottom")
```

